<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.10"/>
<title>libctru: graphics/gpu/geoshader/source/main.c</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { init_search(); });
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">libctru
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.10 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="annotated.html"><span>Data&#160;Structures</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
      <li><a href="examples.html"><span>Examples</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
</div><!-- top -->
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">graphics/gpu/geoshader/source/main.c</div>  </div>
</div><!--header-->
<div class="contents">
<p>graphics/gpu/geoshader/source/gpu.h </p><div class="fragment"><div class="line"><span class="comment">/*</span></div>
<div class="line"><span class="comment"> * Bare-bones simplistic GPU wrapper</span></div>
<div class="line"><span class="comment"> * This library is common to all libctru GPU examples</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#pragma once</span></div>
<div class="line"><span class="preprocessor">#include &lt;string.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;<a class="code" href="3ds_8h.html">3ds.h</a>&gt;</span></div>
<div class="line"><span class="preprocessor">#include &quot;3dmath.h&quot;</span></div>
<div class="line"></div>
<div class="line"><span class="keywordtype">void</span> gpuInit(<span class="keywordtype">void</span>);</div>
<div class="line"><span class="keywordtype">void</span> gpuExit(<span class="keywordtype">void</span>);</div>
<div class="line"></div>
<div class="line"><span class="keywordtype">void</span> gpuClearBuffers(<a class="code" href="types_8h.html#afaa62991928fb9fb18ff0db62a040aba">u32</a> clearColor);</div>
<div class="line"></div>
<div class="line"><span class="keywordtype">void</span> gpuFrameBegin(<span class="keywordtype">void</span>);</div>
<div class="line"><span class="keywordtype">void</span> gpuFrameEnd(<span class="keywordtype">void</span>);</div>
<div class="line"></div>
<div class="line"><span class="comment">// Configures the specified fixed-function fragment shading substage to be a no-operation</span></div>
<div class="line"><span class="keywordtype">void</span> GPU_SetDummyTexEnv(<span class="keywordtype">int</span> <span class="keywordtype">id</span>);</div>
<div class="line"></div>
<div class="line"><span class="comment">// Uploads an uniform matrix</span></div>
<div class="line"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">void</span> GPU_SetFloatUniformMatrix(<a class="code" href="enums_8h.html#a178882ce0f114a22e19ff7f0ee842de5">GPU_SHADER_TYPE</a> type, <span class="keywordtype">int</span> location, matrix_4x4* matrix)</div>
<div class="line">{</div>
<div class="line">    <a name="a0"></a><a class="code" href="gpu-old_8h.html#af18a38db985563a54813c2ebf86d6509">GPU_SetFloatUniform</a>(type, location, (<a class="code" href="types_8h.html#afaa62991928fb9fb18ff0db62a040aba">u32</a>*)matrix, 4);</div>
<div class="line">}</div>
</div><!-- fragment --><p> graphics/gpu/geoshader/source/gpu.c </p><div class="fragment"><div class="line"><span class="preprocessor">#include &quot;<a class="code" href="gpu_8h.html">gpu.h</a>&quot;</span></div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#define DISPLAY_TRANSFER_FLAGS \</span></div>
<div class="line"><span class="preprocessor">    (GX_TRANSFER_FLIP_VERT(0) | GX_TRANSFER_OUT_TILED(0) | GX_TRANSFER_RAW_COPY(0) | \</span></div>
<div class="line"><span class="preprocessor">    GX_TRANSFER_IN_FORMAT(GX_TRANSFER_FMT_RGBA8) | GX_TRANSFER_OUT_FORMAT(GX_TRANSFER_FMT_RGB8) | \</span></div>
<div class="line"><span class="preprocessor">    GX_TRANSFER_SCALING(GX_TRANSFER_SCALE_NO))</span></div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> <a class="code" href="types_8h.html#afaa62991928fb9fb18ff0db62a040aba">u32</a> *colorBuf, *depthBuf;</div>
<div class="line"><span class="keyword">static</span> <a class="code" href="types_8h.html#afaa62991928fb9fb18ff0db62a040aba">u32</a> *cmdBuf;</div>
<div class="line"></div>
<div class="line"><span class="keywordtype">void</span> gpuInit(<span class="keywordtype">void</span>)</div>
<div class="line">{</div>
<div class="line">    colorBuf = <a name="a1"></a><a class="code" href="vram_8h.html#a00b84b8d38c127d8af9a89b9b7e2a5a4">vramAlloc</a>(400*240*4);</div>
<div class="line">    depthBuf = <a class="code" href="vram_8h.html#a00b84b8d38c127d8af9a89b9b7e2a5a4">vramAlloc</a>(400*240*4);</div>
<div class="line">    cmdBuf = <a name="a2"></a><a class="code" href="linear_8h.html#a73a6bd0b398a08f695e16e07267a7424">linearAlloc</a>(0x40000*4);</div>
<div class="line"></div>
<div class="line">    <a name="a3"></a><a class="code" href="gpu-old_8h.html#a921bb00def7171c1936fa50c6e464fba">GPU_Init</a>(NULL);</div>
<div class="line">    <a name="a4"></a><a class="code" href="gpu-old_8h.html#a896e2be6136bb62909be966cc74eeb4d">GPU_Reset</a>(NULL, cmdBuf, 0x40000);</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keywordtype">void</span> gpuExit(<span class="keywordtype">void</span>)</div>
<div class="line">{</div>
<div class="line">    <a name="a5"></a><a class="code" href="linear_8h.html#aeb28d4069fd209e0067ac185fb9b83e2">linearFree</a>(cmdBuf);</div>
<div class="line">    <a name="a6"></a><a class="code" href="vram_8h.html#a867318cde93cdd997588d6dcbfc584e1">vramFree</a>(depthBuf);</div>
<div class="line">    <a class="code" href="vram_8h.html#a867318cde93cdd997588d6dcbfc584e1">vramFree</a>(colorBuf);</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keywordtype">void</span> gpuClearBuffers(<a class="code" href="types_8h.html#afaa62991928fb9fb18ff0db62a040aba">u32</a> clearColor)</div>
<div class="line">{</div>
<div class="line">    <a name="a7"></a><a class="code" href="gx_8h.html#aa6e39b328383930b64eaa230bc9bc6a0">GX_MemoryFill</a>(</div>
<div class="line">        colorBuf, clearColor, &amp;colorBuf[240*400], <a name="a8"></a><a class="code" href="gx_8h.html#af2a0de60baddb7fc1528a62e4e555273a2b6413914fd7889d0ad0610ed4bb5efd">GX_FILL_TRIGGER</a> | <a name="a9"></a><a class="code" href="gx_8h.html#af2a0de60baddb7fc1528a62e4e555273a2642ecb73c80fe5272c041350c08134d">GX_FILL_32BIT_DEPTH</a>,</div>
<div class="line">        depthBuf, 0,          &amp;depthBuf[240*400], <a class="code" href="gx_8h.html#af2a0de60baddb7fc1528a62e4e555273a2b6413914fd7889d0ad0610ed4bb5efd">GX_FILL_TRIGGER</a> | <a class="code" href="gx_8h.html#af2a0de60baddb7fc1528a62e4e555273a2642ecb73c80fe5272c041350c08134d">GX_FILL_32BIT_DEPTH</a>);</div>
<div class="line">    <a name="a10"></a><a class="code" href="gspgpu_8h.html#a704e891a5d988f4964c24dc2b8bac787">gspWaitForPSC0</a>(); <span class="comment">// Wait for the fill to complete</span></div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keywordtype">void</span> gpuFrameBegin(<span class="keywordtype">void</span>)</div>
<div class="line">{</div>
<div class="line">    <span class="comment">// Configure the viewport and the depth linear conversion function</span></div>
<div class="line">    <a name="a11"></a><a class="code" href="gpu-old_8h.html#aba80c2d6e88cb75263de89a2d059e230">GPU_SetViewport</a>(</div>
<div class="line">        (<a class="code" href="types_8h.html#afaa62991928fb9fb18ff0db62a040aba">u32</a>*)<a name="a12"></a><a class="code" href="os_8h.html#ad5be83050dcdaf4ba7824a2afd420866">osConvertVirtToPhys</a>(depthBuf),</div>
<div class="line">        (<a class="code" href="types_8h.html#afaa62991928fb9fb18ff0db62a040aba">u32</a>*)<a class="code" href="os_8h.html#ad5be83050dcdaf4ba7824a2afd420866">osConvertVirtToPhys</a>(colorBuf),</div>
<div class="line">        0, 0, 240, 400); <span class="comment">// The top screen is physically 240x400 pixels</span></div>
<div class="line">    <a name="a13"></a><a class="code" href="gpu-old_8h.html#a8b8de4eb721e55913ad0641c64fbaa75">GPU_DepthMap</a>(-1.0f, 0.0f); <span class="comment">// calculate the depth value from the Z coordinate in the following way: -1.0*z + 0.0</span></div>
<div class="line"></div>
<div class="line">    <span class="comment">// Configure some boilerplate</span></div>
<div class="line">    <a name="a14"></a><a class="code" href="gpu-old_8h.html#a717ac338a87549c36a9d70f5c1d7a077">GPU_SetFaceCulling</a>(<a name="a15"></a><a class="code" href="enums_8h.html#aded31eec5d2f72ea5c6141f24d8a0174a5f4f59f8f711f0bcfa9ca8b87f169ee0">GPU_CULL_BACK_CCW</a>);</div>
<div class="line">    <a name="a16"></a><a class="code" href="gpu-old_8h.html#abc687b8c34463fd1ceacd64dab6c078e">GPU_SetStencilTest</a>(<span class="keyword">false</span>, <a name="a17"></a><a class="code" href="enums_8h.html#ad964a2dd9f856d413d01dc81d5712618a2021d04562bc3b47a305c57dff840c2e">GPU_ALWAYS</a>, 0x00, 0xFF, 0x00);</div>
<div class="line">    <a name="a18"></a><a class="code" href="gpu-old_8h.html#aa2512e6c918e4ce998899d589a20dc2b">GPU_SetStencilOp</a>(<a name="a19"></a><a class="code" href="enums_8h.html#ab7737bd79ec87b48dd2815e54a0f78c1a2ef8af6e032c0cd8613259aef01f0477">GPU_STENCIL_KEEP</a>, <a class="code" href="enums_8h.html#ab7737bd79ec87b48dd2815e54a0f78c1a2ef8af6e032c0cd8613259aef01f0477">GPU_STENCIL_KEEP</a>, <a class="code" href="enums_8h.html#ab7737bd79ec87b48dd2815e54a0f78c1a2ef8af6e032c0cd8613259aef01f0477">GPU_STENCIL_KEEP</a>);</div>
<div class="line">    <a name="a20"></a><a class="code" href="gpu-old_8h.html#a2ead0a88519b4197e13c6ce8e138d6c7">GPU_SetBlendingColor</a>(0,0,0,0);</div>
<div class="line">    <a name="a21"></a><a class="code" href="gpu-old_8h.html#a8c32fb10ed5457b2e3a9273db61187d3">GPU_SetDepthTestAndWriteMask</a>(<span class="keyword">true</span>, <a name="a22"></a><a class="code" href="enums_8h.html#ad964a2dd9f856d413d01dc81d5712618a939d397eee5556dccc012bddfd0dd46a">GPU_GREATER</a>, <a name="a23"></a><a class="code" href="enums_8h.html#a7fffcfca8e93491a90d7b54cce719cd3ae6311b606a2db6df1e7358ad79e297a0">GPU_WRITE_ALL</a>);</div>
<div class="line"></div>
<div class="line">    <span class="comment">// This is unknown</span></div>
<div class="line">    <a name="a24"></a><a class="code" href="gpu_8h.html#a9042ca3f0e361abe2a2ede7206376cb5">GPUCMD_AddMaskedWrite</a>(<a name="a25"></a><a class="code" href="registers_8h.html#a3277f667dc9f64cc3919a17905739ee5">GPUREG_0062</a>, 0x1, 0);</div>
<div class="line">    <a name="a26"></a><a class="code" href="gpu_8h.html#a1251c8456a0f92b49eecbe2c21f0a9a0">GPUCMD_AddWrite</a>(<a name="a27"></a><a class="code" href="registers_8h.html#a92f1665426a2f0932997457dab412e3e">GPUREG_0118</a>, 0);</div>
<div class="line"></div>
<div class="line">    <span class="comment">// Configure alpha blending and test</span></div>
<div class="line">    <a name="a28"></a><a class="code" href="gpu-old_8h.html#ac9bf249df1e7a27a56a4e57c81d19e1c">GPU_SetAlphaBlending</a>(<a name="a29"></a><a class="code" href="enums_8h.html#ade416bc8de7b235e270c76f371d3cfb5a39318f81ae768d8a6119e7965a11bd50">GPU_BLEND_ADD</a>, <a class="code" href="enums_8h.html#ade416bc8de7b235e270c76f371d3cfb5a39318f81ae768d8a6119e7965a11bd50">GPU_BLEND_ADD</a>, <a name="a30"></a><a class="code" href="enums_8h.html#a2a140d854f0e7c97cec2b38f4a226fe1af2ec416dc4e7e8562e61d5f7963e8a36">GPU_SRC_ALPHA</a>, <a name="a31"></a><a class="code" href="enums_8h.html#a2a140d854f0e7c97cec2b38f4a226fe1a7bf978d71679e5507689e4570d3d85b2">GPU_ONE_MINUS_SRC_ALPHA</a>, <a class="code" href="enums_8h.html#a2a140d854f0e7c97cec2b38f4a226fe1af2ec416dc4e7e8562e61d5f7963e8a36">GPU_SRC_ALPHA</a>, <a class="code" href="enums_8h.html#a2a140d854f0e7c97cec2b38f4a226fe1a7bf978d71679e5507689e4570d3d85b2">GPU_ONE_MINUS_SRC_ALPHA</a>);</div>
<div class="line">    <a name="a32"></a><a class="code" href="gpu-old_8h.html#aec1714fa8c2684020ab10a4da8e784e0">GPU_SetAlphaTest</a>(<span class="keyword">false</span>, <a class="code" href="enums_8h.html#ad964a2dd9f856d413d01dc81d5712618a2021d04562bc3b47a305c57dff840c2e">GPU_ALWAYS</a>, 0x00);</div>
<div class="line"></div>
<div class="line">    <span class="keywordtype">int</span> i;</div>
<div class="line">    <span class="keywordflow">for</span> (i = 0; i &lt; 6; i ++)</div>
<div class="line">        GPU_SetDummyTexEnv(i);</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keywordtype">void</span> gpuFrameEnd(<span class="keywordtype">void</span>)</div>
<div class="line">{</div>
<div class="line">    <span class="comment">// Finish rendering</span></div>
<div class="line">    <a name="a33"></a><a class="code" href="gpu-old_8h.html#a0c6bf377d3b218402cca69bb16778fd5">GPU_FinishDrawing</a>();</div>
<div class="line">    <a name="a34"></a><a class="code" href="gpu_8h.html#a418b5471dc141d47267cbc9b8facc4a3">GPUCMD_Finalize</a>();</div>
<div class="line">    <a name="a35"></a><a class="code" href="gpu_8h.html#a7a806155f4e52af7775737d45d9342d5">GPUCMD_FlushAndRun</a>();</div>
<div class="line">    <a name="a36"></a><a class="code" href="gspgpu_8h.html#aba84a82e0137f5dc7a5c9d0ece41d9b7">gspWaitForP3D</a>(); <span class="comment">// Wait for the rendering to complete</span></div>
<div class="line"></div>
<div class="line">    <span class="comment">// Transfer the GPU output to the framebuffer</span></div>
<div class="line">    <a name="a37"></a><a class="code" href="gx_8h.html#a4de1f2c27d7984b8cf5b93c8913a499b">GX_DisplayTransfer</a>(</div>
<div class="line">        colorBuf, <a name="a38"></a><a class="code" href="gx_8h.html#ad34237bd30a2a96a6074e8967840d4fc">GX_BUFFER_DIM</a>(240, 400),</div>
<div class="line">        (<a class="code" href="types_8h.html#afaa62991928fb9fb18ff0db62a040aba">u32</a>*)<a name="a39"></a><a class="code" href="gfx_8h.html#a332447352568e250a75397a1b2e452db">gfxGetFramebuffer</a>(<a name="a40"></a><a class="code" href="gfx_8h.html#a356112d87f5cf6bbba3ea3b6b010e09caf9d44178134d07cf9c5923200e14af09">GFX_TOP</a>, <a name="a41"></a><a class="code" href="gfx_8h.html#ab9bacc1d598f0f6e4d5ef8bbeb466b03a1bfda6a35adc49eb4631246ea4e637e1">GFX_LEFT</a>, NULL, NULL), <a class="code" href="gx_8h.html#ad34237bd30a2a96a6074e8967840d4fc">GX_BUFFER_DIM</a>(240, 400),</div>
<div class="line">        DISPLAY_TRANSFER_FLAGS);</div>
<div class="line">    <a name="a42"></a><a class="code" href="gspgpu_8h.html#a2f2aca81b76a88b6ebb121ec54f76b7e">gspWaitForPPF</a>(); <span class="comment">// Wait for the transfer to complete</span></div>
<div class="line"></div>
<div class="line">    <span class="comment">// Reset the command buffer</span></div>
<div class="line">    <a name="a43"></a><a class="code" href="gpu_8h.html#a42142a7ec0fd6ac9941d454f7e18415a">GPUCMD_SetBufferOffset</a>(0);</div>
<div class="line">};</div>
<div class="line"></div>
<div class="line"><span class="keywordtype">void</span> GPU_SetDummyTexEnv(<span class="keywordtype">int</span> <span class="keywordtype">id</span>)</div>
<div class="line">{</div>
<div class="line">    <a name="a44"></a><a class="code" href="gpu-old_8h.html#a7b61022c85fa068574fd6b61d55f9530">GPU_SetTexEnv</a>(<span class="keywordtype">id</span>,</div>
<div class="line">        <a name="a45"></a><a class="code" href="enums_8h.html#abb62754733c37a8490767fd8e004b903">GPU_TEVSOURCES</a>(<a name="a46"></a><a class="code" href="enums_8h.html#a43f47361b7edcab3c6b7d064c09ae7d0a1b960db2c45d309c5e4d9c899d051936">GPU_PREVIOUS</a>, 0, 0),</div>
<div class="line">        <a class="code" href="enums_8h.html#abb62754733c37a8490767fd8e004b903">GPU_TEVSOURCES</a>(<a class="code" href="enums_8h.html#a43f47361b7edcab3c6b7d064c09ae7d0a1b960db2c45d309c5e4d9c899d051936">GPU_PREVIOUS</a>, 0, 0),</div>
<div class="line">        <a name="a47"></a><a class="code" href="enums_8h.html#a4f2c9311619707a1276457d94b06a983">GPU_TEVOPERANDS</a>(0, 0, 0),</div>
<div class="line">        <a class="code" href="enums_8h.html#a4f2c9311619707a1276457d94b06a983">GPU_TEVOPERANDS</a>(0, 0, 0),</div>
<div class="line">        <a name="a48"></a><a class="code" href="enums_8h.html#a07c36c673c5ca75d946367821c8afdd0a1c5123d469abc61be2501b97b512cc11">GPU_REPLACE</a>,</div>
<div class="line">        <a class="code" href="enums_8h.html#a07c36c673c5ca75d946367821c8afdd0a1c5123d469abc61be2501b97b512cc11">GPU_REPLACE</a>,</div>
<div class="line">        0xFFFFFFFF);</div>
<div class="line">}</div>
</div><!-- fragment --><p> graphics/gpu/geoshader/source/3dmath.h </p><div class="fragment"><div class="line"><span class="comment">/*</span></div>
<div class="line"><span class="comment"> * Bare-bones simplistic 3D math library</span></div>
<div class="line"><span class="comment"> * This library is common to all libctru GPU examples</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#pragma once</span></div>
<div class="line"><span class="preprocessor">#include &lt;string.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;stdbool.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;math.h&gt;</span></div>
<div class="line"></div>
<div class="line"><span class="keyword">typedef</span> <span class="keyword">union </span>{ <span class="keyword">struct </span>{ <span class="keywordtype">float</span> w, z, y, x; }; <span class="keywordtype">float</span> c[4]; } vector_4f;</div>
<div class="line"><span class="keyword">typedef</span> <span class="keyword">struct </span>{ vector_4f r[4]; } matrix_4x4;</div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">float</span> v4f_dp4(<span class="keyword">const</span> vector_4f* a, <span class="keyword">const</span> vector_4f* b)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordflow">return</span> a-&gt;x*b-&gt;x + a-&gt;y*b-&gt;y + a-&gt;z*b-&gt;z + a-&gt;w*b-&gt;w;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">float</span> v4f_mod4(<span class="keyword">const</span> vector_4f* a)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordflow">return</span> sqrtf(v4f_dp4(a,a));</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">void</span> v4f_norm4(vector_4f* vec)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordtype">float</span> m = v4f_mod4(vec);</div>
<div class="line">    <span class="keywordflow">if</span> (m == 0.0) <span class="keywordflow">return</span>;</div>
<div class="line">    vec-&gt;x /= m;</div>
<div class="line">    vec-&gt;y /= m;</div>
<div class="line">    vec-&gt;z /= m;</div>
<div class="line">    vec-&gt;w /= m;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">void</span> m4x4_zeros(matrix_4x4* out)</div>
<div class="line">{</div>
<div class="line">    memset(out, 0, <span class="keyword">sizeof</span>(*out));</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">void</span> m4x4_copy(matrix_4x4* out, <span class="keyword">const</span> matrix_4x4* in)</div>
<div class="line">{</div>
<div class="line">    memcpy(out, in, <span class="keyword">sizeof</span>(*out));</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keywordtype">void</span> m4x4_identity(matrix_4x4* out);</div>
<div class="line"><span class="keywordtype">void</span> m4x4_multiply(matrix_4x4* out, <span class="keyword">const</span> matrix_4x4* a, <span class="keyword">const</span> matrix_4x4* b);</div>
<div class="line"></div>
<div class="line"><span class="keywordtype">void</span> m4x4_translate(matrix_4x4* mtx, <span class="keywordtype">float</span> x, <span class="keywordtype">float</span> y, <span class="keywordtype">float</span> z);</div>
<div class="line"><span class="keywordtype">void</span> m4x4_scale(matrix_4x4* mtx, <span class="keywordtype">float</span> x, <span class="keywordtype">float</span> y, <span class="keywordtype">float</span> z);</div>
<div class="line"></div>
<div class="line"><span class="keywordtype">void</span> m4x4_rotate_x(matrix_4x4* mtx, <span class="keywordtype">float</span> angle, <span class="keywordtype">bool</span> bRightSide);</div>
<div class="line"><span class="keywordtype">void</span> m4x4_rotate_y(matrix_4x4* mtx, <span class="keywordtype">float</span> angle, <span class="keywordtype">bool</span> bRightSide);</div>
<div class="line"><span class="keywordtype">void</span> m4x4_rotate_z(matrix_4x4* mtx, <span class="keywordtype">float</span> angle, <span class="keywordtype">bool</span> bRightSide);</div>
<div class="line"></div>
<div class="line"><span class="comment">// Special versions of the projection matrices that take the 3DS&#39; screen orientation into account</span></div>
<div class="line"><span class="keywordtype">void</span> m4x4_ortho_tilt(matrix_4x4* mtx, <span class="keywordtype">float</span> left, <span class="keywordtype">float</span> right, <span class="keywordtype">float</span> bottom, <span class="keywordtype">float</span> top, <span class="keywordtype">float</span> near, <span class="keywordtype">float</span> far);</div>
<div class="line"><span class="keywordtype">void</span> m4x4_persp_tilt(matrix_4x4* mtx, <span class="keywordtype">float</span> fovy, <span class="keywordtype">float</span> aspect, <span class="keywordtype">float</span> near, <span class="keywordtype">float</span> far);</div>
</div><!-- fragment --><p> graphics/gpu/geoshader/source/3dmath.c </p><div class="fragment"><div class="line"><span class="preprocessor">#include &quot;3dmath.h&quot;</span></div>
<div class="line"></div>
<div class="line"><span class="keywordtype">void</span> m4x4_identity(matrix_4x4* out)</div>
<div class="line">{</div>
<div class="line">    m4x4_zeros(out);</div>
<div class="line">    out-&gt;r[0].x = out-&gt;r[1].y = out-&gt;r[2].z = out-&gt;r[3].w = 1.0f;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keywordtype">void</span> m4x4_multiply(matrix_4x4* out, <span class="keyword">const</span> matrix_4x4* a, <span class="keyword">const</span> matrix_4x4* b)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordtype">int</span> i, j;</div>
<div class="line">    <span class="keywordflow">for</span> (i = 0; i &lt; 4; i ++)</div>
<div class="line">        <span class="keywordflow">for</span> (j = 0; j &lt; 4; j ++)</div>
<div class="line">            out-&gt;r[j].c[i] = a-&gt;r[j].x*b-&gt;r[0].c[i] + a-&gt;r[j].y*b-&gt;r[1].c[i] + a-&gt;r[j].z*b-&gt;r[2].c[i] + a-&gt;r[j].w*b-&gt;r[3].c[i];</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keywordtype">void</span> m4x4_translate(matrix_4x4* mtx, <span class="keywordtype">float</span> x, <span class="keywordtype">float</span> y, <span class="keywordtype">float</span> z)</div>
<div class="line">{</div>
<div class="line">    matrix_4x4 tm, om;</div>
<div class="line"></div>
<div class="line">    m4x4_identity(&amp;tm);</div>
<div class="line">    tm.r[0].w = x;</div>
<div class="line">    tm.r[1].w = y;</div>
<div class="line">    tm.r[2].w = z;</div>
<div class="line"></div>
<div class="line">    m4x4_multiply(&amp;om, mtx, &amp;tm);</div>
<div class="line">    m4x4_copy(mtx, &amp;om);</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keywordtype">void</span> m4x4_scale(matrix_4x4* mtx, <span class="keywordtype">float</span> x, <span class="keywordtype">float</span> y, <span class="keywordtype">float</span> z)</div>
<div class="line">{</div>
<div class="line">    <span class="keywordtype">int</span> i;</div>
<div class="line">    <span class="keywordflow">for</span> (i = 0; i &lt; 4; i ++)</div>
<div class="line">    {</div>
<div class="line">        mtx-&gt;r[i].x *= x;</div>
<div class="line">        mtx-&gt;r[i].y *= y;</div>
<div class="line">        mtx-&gt;r[i].z *= z;</div>
<div class="line">    }</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keywordtype">void</span> m4x4_rotate_x(matrix_4x4* mtx, <span class="keywordtype">float</span> angle, <span class="keywordtype">bool</span> bRightSide)</div>
<div class="line">{</div>
<div class="line">    matrix_4x4 rm, om;</div>
<div class="line"></div>
<div class="line">    <span class="keywordtype">float</span> cosAngle = cosf(angle);</div>
<div class="line">    <span class="keywordtype">float</span> sinAngle = sinf(angle);</div>
<div class="line"></div>
<div class="line">    m4x4_zeros(&amp;rm);</div>
<div class="line">    rm.r[0].x = 1.0f;</div>
<div class="line">    rm.r[1].y = cosAngle;</div>
<div class="line">    rm.r[1].z = sinAngle;</div>
<div class="line">    rm.r[2].y = -sinAngle;</div>
<div class="line">    rm.r[2].z = cosAngle;</div>
<div class="line">    rm.r[3].w = 1.0f;</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span> (bRightSide) m4x4_multiply(&amp;om, mtx, &amp;rm);</div>
<div class="line">    <span class="keywordflow">else</span>            m4x4_multiply(&amp;om, &amp;rm, mtx);</div>
<div class="line">    m4x4_copy(mtx, &amp;om);</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keywordtype">void</span> m4x4_rotate_y(matrix_4x4* mtx, <span class="keywordtype">float</span> angle, <span class="keywordtype">bool</span> bRightSide)</div>
<div class="line">{</div>
<div class="line">    matrix_4x4 rm, om;</div>
<div class="line"></div>
<div class="line">    <span class="keywordtype">float</span> cosAngle = cosf(angle);</div>
<div class="line">    <span class="keywordtype">float</span> sinAngle = sinf(angle);</div>
<div class="line"></div>
<div class="line">    m4x4_zeros(&amp;rm);</div>
<div class="line">    rm.r[0].x = cosAngle;</div>
<div class="line">    rm.r[0].z = sinAngle;</div>
<div class="line">    rm.r[1].y = 1.0f;</div>
<div class="line">    rm.r[2].x = -sinAngle;</div>
<div class="line">    rm.r[2].z = cosAngle;</div>
<div class="line">    rm.r[3].w = 1.0f;</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span> (bRightSide) m4x4_multiply(&amp;om, mtx, &amp;rm);</div>
<div class="line">    <span class="keywordflow">else</span>            m4x4_multiply(&amp;om, &amp;rm, mtx);</div>
<div class="line">    m4x4_copy(mtx, &amp;om);</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keywordtype">void</span> m4x4_rotate_z(matrix_4x4* mtx, <span class="keywordtype">float</span> angle, <span class="keywordtype">bool</span> bRightSide)</div>
<div class="line">{</div>
<div class="line">    matrix_4x4 rm, om;</div>
<div class="line"></div>
<div class="line">    <span class="keywordtype">float</span> cosAngle = cosf(angle);</div>
<div class="line">    <span class="keywordtype">float</span> sinAngle = sinf(angle);</div>
<div class="line"></div>
<div class="line">    m4x4_zeros(&amp;rm);</div>
<div class="line">    rm.r[0].x = cosAngle;</div>
<div class="line">    rm.r[0].y = sinAngle;</div>
<div class="line">    rm.r[1].x = -sinAngle;</div>
<div class="line">    rm.r[1].y = cosAngle;</div>
<div class="line">    rm.r[2].z = 1.0f;</div>
<div class="line">    rm.r[3].w = 1.0f;</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span> (bRightSide) m4x4_multiply(&amp;om, mtx, &amp;rm);</div>
<div class="line">    <span class="keywordflow">else</span>            m4x4_multiply(&amp;om, &amp;rm, mtx);</div>
<div class="line">    m4x4_copy(mtx, &amp;om);</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keywordtype">void</span> m4x4_ortho_tilt(matrix_4x4* mtx, <span class="keywordtype">float</span> left, <span class="keywordtype">float</span> right, <span class="keywordtype">float</span> bottom, <span class="keywordtype">float</span> top, <span class="keywordtype">float</span> near, <span class="keywordtype">float</span> far)</div>
<div class="line">{</div>
<div class="line">    matrix_4x4 mp;</div>
<div class="line">    m4x4_zeros(&amp;mp);</div>
<div class="line"></div>
<div class="line">    <span class="comment">// Build standard orthogonal projection matrix</span></div>
<div class="line">    mp.r[0].x = 2.0f / (right - left);</div>
<div class="line">    mp.r[0].w = (left + right) / (left - right);</div>
<div class="line">    mp.r[1].y = 2.0f / (top - bottom);</div>
<div class="line">    mp.r[1].w = (bottom + top) / (bottom - top);</div>
<div class="line">    mp.r[2].z = 2.0f / (near - far);</div>
<div class="line">    mp.r[2].w = (far + near) / (far - near);</div>
<div class="line">    mp.r[3].w = 1.0f;</div>
<div class="line"></div>
<div class="line">    <span class="comment">// Fix depth range to [-1, 0]</span></div>
<div class="line">    matrix_4x4 mp2, mp3;</div>
<div class="line">    m4x4_identity(&amp;mp2);</div>
<div class="line">    mp2.r[2].z = 0.5;</div>
<div class="line">    mp2.r[2].w = -0.5;</div>
<div class="line">    m4x4_multiply(&amp;mp3, &amp;mp2, &amp;mp);</div>
<div class="line"></div>
<div class="line">    <span class="comment">// Fix the 3DS screens&#39; orientation by swapping the X and Y axis</span></div>
<div class="line">    m4x4_identity(&amp;mp2);</div>
<div class="line">    mp2.r[0].x = 0.0;</div>
<div class="line">    mp2.r[0].y = 1.0;</div>
<div class="line">    mp2.r[1].x = -1.0; <span class="comment">// flipped</span></div>
<div class="line">    mp2.r[1].y = 0.0;</div>
<div class="line">    m4x4_multiply(mtx, &amp;mp2, &amp;mp3);</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keywordtype">void</span> m4x4_persp_tilt(matrix_4x4* mtx, <span class="keywordtype">float</span> fovx, <span class="keywordtype">float</span> invaspect, <span class="keywordtype">float</span> near, <span class="keywordtype">float</span> far)</div>
<div class="line">{</div>
<div class="line">    <span class="comment">// Notes:</span></div>
<div class="line">    <span class="comment">// We are passed &quot;fovy&quot; and the &quot;aspect ratio&quot;. However, the 3DS screens are sideways,</span></div>
<div class="line">    <span class="comment">// and so are these parameters -- in fact, they are actually the fovx and the inverse</span></div>
<div class="line">    <span class="comment">// of the aspect ratio. Therefore the formula for the perspective projection matrix</span></div>
<div class="line">    <span class="comment">// had to be modified to be expressed in these terms instead.</span></div>
<div class="line"></div>
<div class="line">    <span class="comment">// Notes:</span></div>
<div class="line">    <span class="comment">// fovx = 2 atan(tan(fovy/2)*w/h)</span></div>
<div class="line">    <span class="comment">// fovy = 2 atan(tan(fovx/2)*h/w)</span></div>
<div class="line">    <span class="comment">// invaspect = h/w</span></div>
<div class="line"></div>
<div class="line">    <span class="comment">// a0,0 = h / (w*tan(fovy/2)) =</span></div>
<div class="line">    <span class="comment">//      = h / (w*tan(2 atan(tan(fovx/2)*h/w) / 2)) =</span></div>
<div class="line">    <span class="comment">//      = h / (w*tan( atan(tan(fovx/2)*h/w) )) =</span></div>
<div class="line">    <span class="comment">//      = h / (w * tan(fovx/2)*h/w) =</span></div>
<div class="line">    <span class="comment">//      = 1 / tan(fovx/2)</span></div>
<div class="line"></div>
<div class="line">    <span class="comment">// a1,1 = 1 / tan(fovy/2) = (...) = w / (h*tan(fovx/2))</span></div>
<div class="line"></div>
<div class="line">    <span class="keywordtype">float</span> fovx_tan = tanf(fovx / 2);</div>
<div class="line">    matrix_4x4 mp;</div>
<div class="line">    m4x4_zeros(&amp;mp);</div>
<div class="line"></div>
<div class="line">    <span class="comment">// Build standard perspective projection matrix</span></div>
<div class="line">    mp.r[0].x = 1.0f / fovx_tan;</div>
<div class="line">    mp.r[1].y = 1.0f / (fovx_tan*invaspect);</div>
<div class="line">    mp.r[2].z = (near + far) / (near - far);</div>
<div class="line">    mp.r[2].w = (2 * near * far) / (near - far);</div>
<div class="line">    mp.r[3].z = -1.0f;</div>
<div class="line"></div>
<div class="line">    <span class="comment">// Fix depth range to [-1, 0]</span></div>
<div class="line">    matrix_4x4 mp2;</div>
<div class="line">    m4x4_identity(&amp;mp2);</div>
<div class="line">    mp2.r[2].z = 0.5;</div>
<div class="line">    mp2.r[2].w = -0.5;</div>
<div class="line">    m4x4_multiply(mtx, &amp;mp2, &amp;mp);</div>
<div class="line"></div>
<div class="line">    <span class="comment">// Rotate the matrix one quarter of a turn CCW in order to fix the 3DS screens&#39; orientation</span></div>
<div class="line">    m4x4_rotate_z(mtx, M_PI / 2, <span class="keyword">true</span>);</div>
<div class="line">}</div>
</div><!-- fragment --><p> graphics/gpu/geoshader/source/vshader.pica </p><div class="fragment"><div class="line">; Example PICA200 vertex shader</div>
<div class="line"></div>
<div class="line">; Constants</div>
<div class="line">.constf myconst(0.0, 1.0, -1.0, -0.5)</div>
<div class="line">.alias  zeros myconst.xxxx ; Vector full of zeros</div>
<div class="line">.alias  ones  myconst.yyyy ; Vector full of ones</div>
<div class="line"></div>
<div class="line">; Outputs - since we are also using a geoshader the output type isn&#39;t really used</div>
<div class="line">.out outpos position</div>
<div class="line">.out outclr color</div>
<div class="line"></div>
<div class="line">; Inputs (defined as aliases for convenience)</div>
<div class="line">.alias inpos v0</div>
<div class="line">.alias inclr v1</div>
<div class="line"></div>
<div class="line">.proc main</div>
<div class="line">    ; Pass through both inputs to the geoshader</div>
<div class="line">    mov outpos.xyz, inpos</div>
<div class="line">    mov outpos.w,   ones</div>
<div class="line">    mov outclr,     inclr</div>
<div class="line"></div>
<div class="line">    ; We&#39;re finished</div>
<div class="line">    end</div>
<div class="line">.end</div>
</div><!-- fragment --><p> graphics/gpu/geoshader/source/gshader.pica </p><div class="fragment"><div class="line">; Example PICA200 geometry shader</div>
<div class="line"></div>
<div class="line">; Uniforms</div>
<div class="line">.fvec projection[4]</div>
<div class="line"></div>
<div class="line">; Constants</div>
<div class="line">.constf myconst(0.0, 1.0, -1.0, 0.5)</div>
<div class="line">.alias  zeros myconst.xxxx ; Vector full of zeros</div>
<div class="line">.alias  ones  myconst.yyyy ; Vector full of ones</div>
<div class="line">.alias  half  myconst.wwww</div>
<div class="line"></div>
<div class="line">; Outputs - this time the type *is* used</div>
<div class="line">.out outpos position</div>
<div class="line">.out outclr color</div>
<div class="line"></div>
<div class="line">; Inputs: we will receive the following inputs:</div>
<div class="line">; v0-v1: position/color of the first vertex</div>
<div class="line">; v2-v3: position/color of the second vertex</div>
<div class="line">; v4-v5: position/color of the third vertex</div>
<div class="line"></div>
<div class="line">.proc main</div>
<div class="line">    ; Calculate the midpoints of the vertices</div>
<div class="line">    mov r4, v0</div>
<div class="line">    add r4, v2,   r4</div>
<div class="line">    mul r4, half, r4</div>
<div class="line">    mov r5, v2</div>
<div class="line">    add r5, v4,   r5</div>
<div class="line">    mul r5, half, r5</div>
<div class="line">    mov r6, v4</div>
<div class="line">    add r6, v0,   r6</div>
<div class="line">    mul r6, half, r6</div>
<div class="line"></div>
<div class="line">    ; Emit the first triangle</div>
<div class="line">    mov r0, v0</div>
<div class="line">    mov r1, r4</div>
<div class="line">    mov r2, r6</div>
<div class="line">    call emit_triangle</div>
<div class="line"></div>
<div class="line">    ; Emit the second triangle</div>
<div class="line">    mov r0, r4</div>
<div class="line">    mov r1, v2</div>
<div class="line">    mov r2, r5</div>
<div class="line">    call emit_triangle</div>
<div class="line"></div>
<div class="line">    ; Emit the third triangle</div>
<div class="line">    mov r0, r6</div>
<div class="line">    mov r1, r5</div>
<div class="line">    mov r2, v4</div>
<div class="line">    call emit_triangle</div>
<div class="line"></div>
<div class="line">    ; We&#39;re finished</div>
<div class="line">    end</div>
<div class="line">.end</div>
<div class="line"></div>
<div class="line">.proc emit_triangle</div>
<div class="line">    ; Emit the first vertex</div>
<div class="line">    setemit 0</div>
<div class="line">    mov r8, r0</div>
<div class="line">    mov r9, v1</div>
<div class="line">    call process_vertex</div>
<div class="line">    emit</div>
<div class="line"></div>
<div class="line">    ; Emit the second vertex</div>
<div class="line">    setemit 1</div>
<div class="line">    mov r8, r1</div>
<div class="line">    mov r9, v3</div>
<div class="line">    call process_vertex</div>
<div class="line">    emit</div>
<div class="line"></div>
<div class="line">    ; Emit the third vertex and finish the primitive</div>
<div class="line">    setemit 2, prim</div>
<div class="line">    mov r8, r2</div>
<div class="line">    mov r9, v5</div>
<div class="line">    call process_vertex</div>
<div class="line">    emit</div>
<div class="line">.end</div>
<div class="line"></div>
<div class="line">; Subroutine</div>
<div class="line">; Inputs:</div>
<div class="line">;   r8: vertex position</div>
<div class="line">;   r9: vertex color</div>
<div class="line">.proc process_vertex</div>
<div class="line">    ; outpos = projectionMatrix * r8</div>
<div class="line">    dp4 outpos.x, projection[0], r8</div>
<div class="line">    dp4 outpos.y, projection[1], r8</div>
<div class="line">    dp4 outpos.z, projection[2], r8</div>
<div class="line">    dp4 outpos.w, projection[3], r8</div>
<div class="line"></div>
<div class="line">    ; outclr = r9</div>
<div class="line">    mov outclr, r9</div>
<div class="line">.end</div>
</div><!-- fragment --><div class="fragment"><div class="line"><span class="comment">/*</span></div>
<div class="line"><span class="comment"> * ~~ Simple libctru GPU geometry shader example ~~</span></div>
<div class="line"><span class="comment"> * This example demonstrates the basics of using the PICA200 in a 3DS homebrew</span></div>
<div class="line"><span class="comment"> * application in order to render a basic scene using a geoshader.</span></div>
<div class="line"><span class="comment"> * The example geoshader receives the vertices of a triangle and emits three</span></div>
<div class="line"><span class="comment"> * smaller triangles, thus forming a &#39;triforce&#39; shape.</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#include &quot;<a class="code" href="gpu_8h.html">gpu.h</a>&quot;</span></div>
<div class="line"><span class="preprocessor">#include &quot;vshader_shbin.h&quot;</span></div>
<div class="line"><span class="preprocessor">#include &quot;gshader_shbin.h&quot;</span></div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#define CLEAR_COLOR 0x68B0D8FF</span></div>
<div class="line"></div>
<div class="line"><span class="keyword">typedef</span> <span class="keyword">struct </span>{ <span class="keywordtype">float</span> position[3]; <span class="keywordtype">float</span> color[4]; } vertex;</div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> <span class="keyword">const</span> vertex vertex_list[] =</div>
<div class="line">{</div>
<div class="line">    { {200.0f, 200.0f, 0.5f}, {1.0f, 0.0f, 0.0f, 1.0f} },</div>
<div class="line">    { {100.0f,  40.0f, 0.5f}, {0.0f, 1.0f, 0.0f, 1.0f} },</div>
<div class="line">    { {300.0f,  40.0f, 0.5f}, {0.0f, 0.0f, 1.0f, 1.0f} },</div>
<div class="line">};</div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#define vertex_list_count (sizeof(vertex_list)/sizeof(vertex_list[0]))</span></div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> <a name="_a49"></a><a class="code" href="structDVLB__s.html">DVLB_s</a> *vshader_dvlb, *gshader_dvlb;</div>
<div class="line"><span class="keyword">static</span> <a name="_a50"></a><a class="code" href="structshaderProgram__s.html">shaderProgram_s</a> program;</div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">int</span> uLoc_projection;</div>
<div class="line"><span class="keyword">static</span> matrix_4x4 projection;</div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span>* vbo_data;</div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> sceneInit(<span class="keywordtype">void</span>)</div>
<div class="line">{</div>
<div class="line">    <span class="comment">// Load the shaders and create a shader program</span></div>
<div class="line">    <span class="comment">// The geoshader stride is set to 6 so that it processes a triangle at a time</span></div>
<div class="line">    vshader_dvlb = <a name="a51"></a><a class="code" href="shbin_8h.html#afd50bf30516e9e3acffd3b62cd061cb0">DVLB_ParseFile</a>((<a class="code" href="types_8h.html#afaa62991928fb9fb18ff0db62a040aba">u32</a>*)vshader_shbin, vshader_shbin_size);</div>
<div class="line">    gshader_dvlb = <a class="code" href="shbin_8h.html#afd50bf30516e9e3acffd3b62cd061cb0">DVLB_ParseFile</a>((<a class="code" href="types_8h.html#afaa62991928fb9fb18ff0db62a040aba">u32</a>*)gshader_shbin, gshader_shbin_size);</div>
<div class="line">    <a name="a52"></a><a class="code" href="shaderProgram_8h.html#a4907e3572c644efe27c130a8c37bddf0">shaderProgramInit</a>(&amp;program);</div>
<div class="line">    <a name="a53"></a><a class="code" href="shaderProgram_8h.html#a3ca416a2e6bc3c2aaae1895435e8452c">shaderProgramSetVsh</a>(&amp;program, &amp;vshader_dvlb-&gt;<a name="a54"></a><a class="code" href="structDVLB__s.html#a1934abe9c4109579746d57c5b20b5834">DVLE</a>[0]);</div>
<div class="line">    <a name="a55"></a><a class="code" href="shaderProgram_8h.html#a9dfb834657daeaa420744d0d55a857b4">shaderProgramSetGsh</a>(&amp;program, &amp;gshader_dvlb-&gt;<a class="code" href="structDVLB__s.html#a1934abe9c4109579746d57c5b20b5834">DVLE</a>[0], 6);</div>
<div class="line"></div>
<div class="line">    <span class="comment">// Get the location of the projection matrix uniform</span></div>
<div class="line">    uLoc_projection = <a name="a56"></a><a class="code" href="shaderProgram_8h.html#aa3f30bdd60cc64184b17577f13ac57be">shaderInstanceGetUniformLocation</a>(program.<a name="a57"></a><a class="code" href="structshaderProgram__s.html#a80f25550817af2c8163bc95430542f1f">geometryShader</a>, <span class="stringliteral">&quot;projection&quot;</span>);</div>
<div class="line"></div>
<div class="line">    <span class="comment">// Compute the projection matrix</span></div>
<div class="line">    m4x4_ortho_tilt(&amp;projection, 0.0, 400.0, 0.0, 240.0, 0.0, 1.0);</div>
<div class="line"></div>
<div class="line">    <span class="comment">// Create the VBO (vertex buffer object)</span></div>
<div class="line">    vbo_data = <a class="code" href="linear_8h.html#a73a6bd0b398a08f695e16e07267a7424">linearAlloc</a>(<span class="keyword">sizeof</span>(vertex_list));</div>
<div class="line">    memcpy(vbo_data, vertex_list, <span class="keyword">sizeof</span>(vertex_list));</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> sceneRender(<span class="keywordtype">void</span>)</div>
<div class="line">{</div>
<div class="line">    <span class="comment">// Bind the shader program</span></div>
<div class="line">    <a name="a58"></a><a class="code" href="shaderProgram_8h.html#a29749780857245eb8860fe1bda3bcc97">shaderProgramUse</a>(&amp;program);</div>
<div class="line"></div>
<div class="line">    <span class="comment">// Configure the first fragment shading substage to just pass through the vertex color</span></div>
<div class="line">    <span class="comment">// See https://www.opengl.org/sdk/docs/man2/xhtml/glTexEnv.xml for more insight</span></div>
<div class="line">    <a class="code" href="gpu-old_8h.html#a7b61022c85fa068574fd6b61d55f9530">GPU_SetTexEnv</a>(0,</div>
<div class="line">        <a class="code" href="enums_8h.html#abb62754733c37a8490767fd8e004b903">GPU_TEVSOURCES</a>(<a name="a59"></a><a class="code" href="enums_8h.html#a43f47361b7edcab3c6b7d064c09ae7d0a73b71da440440b42a6c282c39e566a0d">GPU_PRIMARY_COLOR</a>, <a class="code" href="enums_8h.html#a43f47361b7edcab3c6b7d064c09ae7d0a73b71da440440b42a6c282c39e566a0d">GPU_PRIMARY_COLOR</a>, <a class="code" href="enums_8h.html#a43f47361b7edcab3c6b7d064c09ae7d0a73b71da440440b42a6c282c39e566a0d">GPU_PRIMARY_COLOR</a>), <span class="comment">// RGB channels</span></div>
<div class="line">        <a class="code" href="enums_8h.html#abb62754733c37a8490767fd8e004b903">GPU_TEVSOURCES</a>(<a class="code" href="enums_8h.html#a43f47361b7edcab3c6b7d064c09ae7d0a73b71da440440b42a6c282c39e566a0d">GPU_PRIMARY_COLOR</a>, <a class="code" href="enums_8h.html#a43f47361b7edcab3c6b7d064c09ae7d0a73b71da440440b42a6c282c39e566a0d">GPU_PRIMARY_COLOR</a>, <a class="code" href="enums_8h.html#a43f47361b7edcab3c6b7d064c09ae7d0a73b71da440440b42a6c282c39e566a0d">GPU_PRIMARY_COLOR</a>), <span class="comment">// Alpha</span></div>
<div class="line">        <a class="code" href="enums_8h.html#a4f2c9311619707a1276457d94b06a983">GPU_TEVOPERANDS</a>(0, 0, 0), <span class="comment">// RGB</span></div>
<div class="line">        <a class="code" href="enums_8h.html#a4f2c9311619707a1276457d94b06a983">GPU_TEVOPERANDS</a>(0, 0, 0), <span class="comment">// Alpha</span></div>
<div class="line">        <a class="code" href="enums_8h.html#a07c36c673c5ca75d946367821c8afdd0a1c5123d469abc61be2501b97b512cc11">GPU_REPLACE</a>, <a class="code" href="enums_8h.html#a07c36c673c5ca75d946367821c8afdd0a1c5123d469abc61be2501b97b512cc11">GPU_REPLACE</a>, <span class="comment">// RGB, Alpha</span></div>
<div class="line">        0xFFFFFFFF);</div>
<div class="line"></div>
<div class="line">    <span class="comment">// Configure the &quot;attribute buffers&quot; (that is, the vertex input buffers)</span></div>
<div class="line">    <a name="a60"></a><a class="code" href="gpu-old_8h.html#ac81475073183a797d1e723770f5cf6b4">GPU_SetAttributeBuffers</a>(</div>
<div class="line">        2, <span class="comment">// Number of inputs per vertex</span></div>
<div class="line">        (<a class="code" href="types_8h.html#afaa62991928fb9fb18ff0db62a040aba">u32</a>*)<a class="code" href="os_8h.html#ad5be83050dcdaf4ba7824a2afd420866">osConvertVirtToPhys</a>(vbo_data), <span class="comment">// Location of the VBO</span></div>
<div class="line">        <a name="a61"></a><a class="code" href="enums_8h.html#aaa7337c142b909e470bbf1ce3c8e9e03">GPU_ATTRIBFMT</a>(0, 3, <a name="a62"></a><a class="code" href="enums_8h.html#a3a62c2be4e88ff3de7c69f1b660d1634af3631e2c847a62946c82604c2faec246">GPU_FLOAT</a>) |</div>
<div class="line">        <a class="code" href="enums_8h.html#aaa7337c142b909e470bbf1ce3c8e9e03">GPU_ATTRIBFMT</a>(1, 4, <a class="code" href="enums_8h.html#a3a62c2be4e88ff3de7c69f1b660d1634af3631e2c847a62946c82604c2faec246">GPU_FLOAT</a>), <span class="comment">// Format of the inputs (in this case the only input is a 3-element float vector)</span></div>
<div class="line">        0xFFC, <span class="comment">// Unused attribute mask, in our case bit 0 is cleared since it is used</span></div>
<div class="line">        0x10, <span class="comment">// Attribute permutations (here it is the identity)</span></div>
<div class="line">        1, <span class="comment">// Number of buffers</span></div>
<div class="line">        (<a class="code" href="types_8h.html#afaa62991928fb9fb18ff0db62a040aba">u32</a>[]) { 0x0 }, <span class="comment">// Buffer offsets (placeholders)</span></div>
<div class="line">        (<a class="code" href="types_8h.html#a3f7e2bcbb0b4c338f3c4f6c937cd4234">u64</a>[]) { 0x10 }, <span class="comment">// Attribute permutations for each buffer (identity again)</span></div>
<div class="line">        (<a class="code" href="types_8h.html#a92c50087ca0e64fa93fc59402c55f8ca">u8</a>[])  { 2 }); <span class="comment">// Number of attributes for each buffer</span></div>
<div class="line"></div>
<div class="line">    <span class="comment">// Upload the projection matrix</span></div>
<div class="line">    GPU_SetFloatUniformMatrix(<a name="a63"></a><a class="code" href="enums_8h.html#a178882ce0f114a22e19ff7f0ee842de5a3a5aa450c7d22bbeb9252de319c635db">GPU_GEOMETRY_SHADER</a>, uLoc_projection, &amp;projection);</div>
<div class="line"></div>
<div class="line">    <span class="comment">// Draw the VBO - GPU_GEOMETRY_PRIM allows the geoshader to control primitive emission</span></div>
<div class="line">    <a name="a64"></a><a class="code" href="gpu-old_8h.html#a4aecce954e20dee2e37e2e774361e9dd">GPU_DrawArray</a>(<a name="a65"></a><a class="code" href="enums_8h.html#a94bdee50fa003d70dd3888f347397806aa5510b7bf1f022edd1a180a2b111cf53">GPU_GEOMETRY_PRIM</a>, 0, vertex_list_count);</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> sceneExit(<span class="keywordtype">void</span>)</div>
<div class="line">{</div>
<div class="line">    <span class="comment">// Free the VBO</span></div>
<div class="line">    <a class="code" href="linear_8h.html#aeb28d4069fd209e0067ac185fb9b83e2">linearFree</a>(vbo_data);</div>
<div class="line"></div>
<div class="line">    <span class="comment">// Free the shader program</span></div>
<div class="line">    <a name="a66"></a><a class="code" href="shaderProgram_8h.html#a57cbd903975f5ccce6169159f89714d8">shaderProgramFree</a>(&amp;program);</div>
<div class="line">    <a name="a67"></a><a class="code" href="shbin_8h.html#a60c02d561312081aefb2096f2b005643">DVLB_Free</a>(vshader_dvlb);</div>
<div class="line">    <a class="code" href="shbin_8h.html#a60c02d561312081aefb2096f2b005643">DVLB_Free</a>(gshader_dvlb);</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keywordtype">int</span> main()</div>
<div class="line">{</div>
<div class="line">    <span class="comment">// Initialize graphics</span></div>
<div class="line">    <a name="a68"></a><a class="code" href="gfx_8h.html#a236a005ae029247c8bfe4a4a649206fc">gfxInitDefault</a>();</div>
<div class="line">    gpuInit();</div>
<div class="line"></div>
<div class="line">    <span class="comment">// Initialize the scene</span></div>
<div class="line">    sceneInit();</div>
<div class="line">    gpuClearBuffers(CLEAR_COLOR);</div>
<div class="line"></div>
<div class="line">    <span class="comment">// Main loop</span></div>
<div class="line">    <span class="keywordflow">while</span> (<a name="a69"></a><a class="code" href="apt_8h.html#a84808c36d9a8c389896ecf241c7f89cb">aptMainLoop</a>())</div>
<div class="line">    {</div>
<div class="line">        <a name="a70"></a><a class="code" href="gspgpu_8h.html#abf0a992835649b5fe90e95d8a58b8c45">gspWaitForVBlank</a>();  <span class="comment">// Synchronize with the start of VBlank</span></div>
<div class="line">        <a name="a71"></a><a class="code" href="gfx_8h.html#a3306df28835a647734cf8e299f041527">gfxSwapBuffersGpu</a>(); <span class="comment">// Swap the framebuffers so that the frame that we rendered last frame is now visible</span></div>
<div class="line">        <a name="a72"></a><a class="code" href="hid_8h.html#abbbf0e1f3a79a75e459e19f85a66bee6">hidScanInput</a>();      <span class="comment">// Read the user input</span></div>
<div class="line"></div>
<div class="line">        <span class="comment">// Respond to user input</span></div>
<div class="line">        <a class="code" href="types_8h.html#afaa62991928fb9fb18ff0db62a040aba">u32</a> kDown = <a name="a73"></a><a class="code" href="hid_8h.html#aa2cababf764bf0b4297dc2e2fffe2a76">hidKeysDown</a>();</div>
<div class="line">        <span class="keywordflow">if</span> (kDown &amp; <a name="a74"></a><a class="code" href="hid_8h.html#aaf8fd5f0e57d456151c951e0f3715fc4a616a1f5c4ed36080ca954453084aea3b">KEY_START</a>)</div>
<div class="line">            <span class="keywordflow">break</span>; <span class="comment">// break in order to return to hbmenu</span></div>
<div class="line"></div>
<div class="line">        <span class="comment">// Render the scene</span></div>
<div class="line">        gpuFrameBegin();</div>
<div class="line">        sceneRender();</div>
<div class="line">        gpuFrameEnd();</div>
<div class="line">        gpuClearBuffers(CLEAR_COLOR);</div>
<div class="line"></div>
<div class="line">        <span class="comment">// Flush the framebuffers out of the data cache (not necessary with pure GPU rendering)</span></div>
<div class="line">        <span class="comment">//gfxFlushBuffers();</span></div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="comment">// Deinitialize the scene</span></div>
<div class="line">    sceneExit();</div>
<div class="line"></div>
<div class="line">    <span class="comment">// Deinitialize graphics</span></div>
<div class="line">    gpuExit();</div>
<div class="line">    <a name="a75"></a><a class="code" href="gfx_8h.html#aa446ccfdfdd4c575e648956ae96f2a3b">gfxExit</a>();</div>
<div class="line">    <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
</div><!-- fragment --> </div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.10
</small></address>
</body>
</html>
